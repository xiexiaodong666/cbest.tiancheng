<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.welfare.persist.mapper.MerchantStoreRelationMapper">
  <sql id="tableName">
        merchant_store_relation
    </sql>

  <sql id="baseColumn">
        id,mer_code,store_code,consum_type,store_alias,is_rebate,rebate_type,rebate_ratio,ramark,flag,create_user,create_time,update_user,update_time,version,status
    </sql>

  <select id="searchMerchantStoreRelations"
    resultType="com.welfare.persist.dto.MerchantStoreRelationDTO">
    SELECT
    msr.id as id,
    msr.STATUS as status,
    msr.create_time as createTime,
    msr.ramark as ramark,
    msr.mer_code as merCode,
    group_concat( msr.store_code ) as storeCode,
    group_concat( msr.store_alias ) as storeAlias,
    m.mer_name as merName
    FROM
    merchant_store_relation msr
    LEFT JOIN merchant m ON m.mer_code = msr.mer_code
    where
    msr.deleted != 1
    <if test="status != null and status !='' ">and msr.status = #{status}
    </if>
    <if test="merName != null and merName !='' ">and m.mer_name = #{merName}
    </if>
    <if test="startTime != null ">and msr.create_time &gt;= #{startTime}</if>
    <if test="endTime != null ">and msr.create_time &lt;= #{endTime}</if>
    GROUP BY
    msr.mer_code
    order by    msr.create_time  desc
  </select>

  <select id="getMerchantStoreRelationListBySyncStatus"
    resultType="com.welfare.persist.entity.MerchantStoreRelation">
    SELECT
    id,
    mer_code as merCode,
    store_code as storeCode,
    consum_type as consumType,
    store_alias as storeAlias,
    is_rebate as isRebate,
    rebate_type as rebateType,
    rebate_ratio as rebateRatio,
    ramark,
    create_user as createUser,
    create_time as createTime,
    update_user as updateUser,
    update_time as updateTime,
    version ,
    deleted,
    status,
    sync_status as syncStatus
    FROM
    merchant_store_relation
    <if test="syncStatus != null ">and sync_status = #{syncStatus}
    </if>
  </select>

  <select id="exportMerchantStoreRelations"
    resultType="com.welfare.persist.dto.MerchantStoreRelationDTO">
    SELECT
    msr.id as id,
    msr.STATUS as status,
    m.create_time as createTime,
    msr.ramark as ramark,
    msr.mer_code as merCode,
    group_concat( msr.store_code ) as storeCode,
    group_concat( msr.store_alias ) as storeAlias,
    m.mer_name as merName
    FROM
    merchant_store_relation msr
    LEFT JOIN merchant m ON m.mer_code = msr.mer_code
    where
    msr.deleted != 1
    <if test="status != null and status !='' ">and msr.status = #{status}
    </if>
    <if test="merName != null and merName !='' ">and m.mer_name = #{merName}
    </if>
    <if test="startTime != null ">and msr.create_time &gt;= #{startTime}</if>
    <if test="endTime != null ">and msr.create_time &lt;= #{endTime}</if>
    GROUP BY
    msr.mer_code
  </select>


  <update id="updateMerchantStoreRelationStatus">
   update merchant_store_relation set sync_status = 1 where id = #{id}
  </update>
</mapper>